{% extends 'catalog/base.html' %}
{% load static %}

{% block title %}Добавить товар - Skystore{% endblock %}
{% block description %}Добавьте новый товар в каталог Skystore{% endblock %}

{% block page_header %}
<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <h1 class="display-4">
        <i class="bi bi-plus-circle-fill text-primary me-3"></i>
        Добавить товар
    </h1>
    <p class="lead">Расширьте наш каталог новым продуктом</p>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <!-- Карточка с формой -->
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white">
                <h4 class="my-0 fw-normal">
                    <i class="bi bi-box-seam me-2"></i>
                    Информация о товаре
                </h4>
            </div>
            <div class="card-body p-4">
                <!-- Форма добавления товара -->
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Название товара -->
                        <div class="col-md-8 mb-4">
                            <label for="name" class="form-label fw-bold">
                                <i class="bi bi-tag text-primary me-1"></i>
                                Название товара *
                            </label>
                            <input type="text" 
                                   name="name" 
                                   class="form-control form-control-lg" 
                                   id="name"
                                   placeholder="Введите название товара"
                                   required
                                   maxlength="200">
                            <div class="invalid-feedback">
                                Пожалуйста, введите название товара.
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Максимум 200 символов
                            </div>
                        </div>
                        
                        <!-- Цена -->
                        <div class="col-md-4 mb-4">
                            <label for="price" class="form-label fw-bold">
                                <i class="bi bi-currency-dollar text-success me-1"></i>
                                Цена *
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       name="price" 
                                       class="form-control form-control-lg" 
                                       id="price"
                                       placeholder="0.00"
                                       step="0.01"
                                       min="0"
                                       required>
                                <span class="input-group-text">₽</span>
                            </div>
                            <div class="invalid-feedback">
                                Пожалуйста, укажите цену товара.
                            </div>
                        </div>
                    </div>

                    <!-- Категория -->
                    <div class="mb-4">
                        <label for="category" class="form-label fw-bold">
                            <i class="bi bi-bookmark text-warning me-1"></i>
                            Категория
                        </label>
                        <select name="category" class="form-select form-select-lg" id="category">
                            <option value="">Выберите категорию (необязательно)</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            Категория поможет покупателям быстрее найти ваш товар
                        </div>
                    </div>

                    <!-- Описание -->
                    <div class="mb-4">
                        <label for="description" class="form-label fw-bold">
                            <i class="bi bi-card-text text-info me-1"></i>
                            Описание товара *
                        </label>
                        <textarea name="description" 
                                  class="form-control" 
                                  id="description" 
                                  rows="5"
                                  placeholder="Подробно опишите ваш товар: особенности, преимущества, технические характеристики..."
                                  required
                                  maxlength="1000"></textarea>
                        <div class="invalid-feedback">
                            Пожалуйста, добавьте описание товара.
                        </div>
                        <div class="form-text">
                            <i class="bi bi-chat-dots me-1"></i>
                            Максимум 1000 символов. Чем подробнее описание, тем больше шансов на продажу!
                        </div>
                    </div>

                    <!-- Изображение -->
                    <div class="mb-4">
                        <label for="image" class="form-label fw-bold">
                            <i class="bi bi-image text-danger me-1"></i>
                            Изображение товара
                        </label>

                        <input type="file"
                               name="image"
                               class="form-control form-control-lg"
                               id="image"
                               accept="image/*">
                        <div class="form-text">
                            <i class="bi bi-camera me-1"></i>
                            Поддерживаются форматы: JPG, PNG, GIF. Максимальный размер: 5 МБ
                        </div>

                        <!-- Превью изображения -->
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <img id="previewImg" class="img-thumbnail" style="max-width: 200px; max-height: 200px;" />
                            <p class="text-muted mt-2">
                                <i class="bi bi-eye me-1"></i>
                                Предварительный просмотр
                            </p>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-lg me-md-2">
                            <i class="bi bi-arrow-left me-2"></i>
                            Отмена
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>
                            Добавить товар
                        </button>
                    </div>
                    
                    <!-- Подсказка -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <small class="text-muted">
                            <i class="bi bi-shield-check text-success me-1"></i>
                            <strong>Поля отмеченные звездочкой (*) обязательны для заполнения.</strong>
                            После добавления товар появится в каталоге и будет доступен для просмотра.
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Валидация формы Bootstrap
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Превью изображения
document.getElementById('image').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

// Счетчик символов для описания
document.getElementById('description').addEventListener('input', function() {
    const maxLength = 1000;
    const currentLength = this.value.length;
    const remaining = maxLength - currentLength;
    
    // Находим или создаем элемент счетчика
    let counter = document.getElementById('description-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.id = 'description-counter';
        counter.className = 'form-text text-end';
        this.parentNode.appendChild(counter);
    }
    
    counter.innerHTML = `<i class="bi bi-pencil me-1"></i>Осталось символов: ${remaining}`;
    
    // Меняем цвет при приближении к лимиту
    if (remaining < 100) {
        counter.className = 'form-text text-end text-warning';
    } else if (remaining < 50) {
        counter.className = 'form-text text-end text-danger';
    } else {
        counter.className = 'form-text text-end text-muted';
    }
});
</script>
{% endblock %}